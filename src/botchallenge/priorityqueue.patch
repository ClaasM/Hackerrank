@@ -762,11 +787,15 @@
         // Read in (and discard) array length
         s.readInt();

+        indices = new HashMap<Object, Integer>(size);
         queue = new Object[size];

         // Read in all elements.
-        for (int i = 0; i < size; i++)
-            queue[i] = s.readObject();
+        for (int i = 0; i < size; i++){
+            Object o = s.readObject();
+            indices.put(o, i);
+            queue[i] = o;
+        }

         // Elements are guaranteed to be in "proper order", but the
         // spec has never explained what that might be.